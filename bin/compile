#!/usr/bin/env bash

# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
#set -x

# config
SHELLINABOX_VERSION="2.14"
NGINX_VERSION="1.4.1"

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
COMPILE_BUILDPACK_DIR=$(cd $(dirname $0) && cd .. && pwd)

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

function package_download() {
  url="$1"
  location="$2"

  mkdir -p $location
  curl $url -s -o - | tar xzf - -C $location
}

echo "Using Shell-in-a-Box version: ${SHELLINABOX_VERSION}" | indent

# s3 packages
SHELLINABOX_URL="http://ci-labs-buildpack-downloads.s3.amazonaws.com/shellinabox/shellinabox-${SHELLINABOX_VERSION}.tar.gz"
FOREGO_URL="https://godist.herokuapp.com/projects/ddollar/forego/releases/current/linux-amd64/forego"
NGINX_URL="https://d35wldypfbhn1h.cloudfront.net/nginx-$NGINX_VERSION.tar.gz"

# vendor directories
VENDORED_SHELLINABOX="${BUILD_DIR}/vendor/shellinabox"
VENDORED_NGINX="${BUILD_DIR}/vendor/nginx"
VENDORED_FOREGO="${BUILD_DIR}/vendor/forego"

# download and unpack packages
echo "-----> Installing Shell-in-a-Box $SHELLINABOX_VERSION"
package_download "${SHELLINABOX_URL}" "${VENDORED_SHELLINABOX}"

echo "-----> Installing Nginx $NGINX_VERSION"
package_download "${NGINX_URL}" "${VENDORED_NGINX}"
mkdir -p ${BUILD_DIR}/config
cp -R $COMPILE_BUILDPACK_DIR/config ${BUILD_DIR}/config

echo "-----> Installing ForeGo"
curl $FOREGO_URL -s -o $VENDORED_FOREGO
chmod +x $VENDORED_FOREGO






